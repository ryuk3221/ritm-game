let delays = [
  1516,
  1945,
  2731,
  3088,
  3516,
  3802,
  3945,
  4088,
  4231,
  4945,
  5374,
  6016,
  6516,
  7231,
  7802,
  8302,
  8516,
  8659,
  8802,
  8874,
  8945,
  9016,
  9088,
  9159,
  9231,
  9516,
  9945,
  10659,
  10945,
  11088,
  11231,
  11302,
  11374,
  11445,
  11588,
  11731,
  11731,
  11802,
  12302,
  12659,
  12945,
  13088,
  13231,
  13374,
  13516,
  13588,
  13659,
  13731,
  13802,
  13874,
  13945,
  14016,
  14088,
  14159,
  14588,
  15302,
  15659,
  16374,
  16802,
  17231,
  17516,
  17659,
  17802,
  17945,
  18088,
  18159,
  18231,
  18302,
  18374,
  18445,
  18516,
  18588,
  18659,
  18731,
  18945,
  19231,
  19516,
  19802,
  19945,
  20088,
  20231,
  20374,
  20516,
  20659,
  20802,
  20945,
  21231,
  21516,
  21802,
  22088,
  22231,
  22374,
  22516,
  22659,
  22802,
  22945,
  23088,
  23231,
  23516,
  23802,
  24088,
  24374,
  24516,
  24659,
  24802,
  24945,
  25088,
  25231,
  25374,
  25516,
  25802,
  26088,
  26374,
  26659,
  26802,
  26945,
  27088,
  27231,
  27302,
  27374,
  27445,
  27516,
  27588,
  27731,
  27802,
  27802,
  28231,
  28945,
  29088,
  29231,
  29374,
  30088,
  30516,
  30945,
  31231,
  31374,
  31516,
  31659,
  31802,
  31874,
  31945,
  32016,
  32016,
  32088,
  32159,
  32231,
  32302,
  32374,
  32659,
  32945,
  33231,
  33516,
  33659,
  33802,
  33945,
  34088,
  34231,
  34445,
  34516,
  34659,
  34945,
  35231,
  35516,
  35802,
  35945,
  36088,
  36231,
  36374,
  36516,
  36659,
  36802,
  36945,
  37231,
  37516,
  37802,
  38088,
  38231,
  38374,
  38516,
  38659,
  38802,
  38945,
  39088,
  39231,
  39516,
  39802,
  40088,
  40374,
  40516,
  40659,
  40802,
  40945,
  41016,
  41088,
  41231,
  41374,
  41445,
  41516,
  41802,
  42088,
  42374,
  42516,
  42659,
  42802,
  42945,
  43088,
  43159,
  43231,
  43374,
  43445,
  43516,
  43659,
  43802,
  44088,
  44374,
  44659,
  44802,
  44945,
  45088,
  45231,
  45374,
  45445,
  45516,
  45659,
  45731,
  45802,
  45945,
  46088,
  46374,
  46659,
  46945,
  47088,
  47231,
  47374,
  47516,
  47659,
  47731,
  47802,
  47945,
  48016,
  48088,
  48231,
  48374,
  48659,
  48945,
  49088,
  49231,
  49374,
  49516,
  49588,
  49659,
  49731,
  49802,
  49874,
  49945,
  50016,
  50088,
  50159,
  50231,
  50302,
  50516,
  50659,
  52945,
  55231,
  56374,
  56945,
  57516,
  57802,
  58088,
  58374,
  58659,
  58802,
  58945,
  59088,
  59231,
  59302,
  59374,
  59445,
  59516,
  59588,
  59659,
  59731,
  59802,
  59802,
  60088,
  60302,
  60516,
  60659,
  60802,
  61088,
  61374,
  61659,
  62088,
  62374,
  62516,
  62802,
  63088,
  63374,
  63659,
  63945,
  64088,
  64231,
  64374,
  64659,
  64945,
  65231,
  65374,
  65659,
  65802,
  65945,
  66016,
  66088,
  66159,
  66231,
  66302,
  66374,
  66731,
  66802,
  66945,
  67088,
  67231,
  67374,
  67516,
  67659,
  67802,
  67945,
  68088,
  68231,
  68374,
  68516,
  68659,
  68802,
  68945,
  69231,
  69445,
  69659,
  69802,
  69945,
  70231,
  70516,
  70802,
  71231,
  71516,
  71659,
  71945,
  72231,
  72516,
  72802,
  73088,
  73231,
  73374,
  73516,
  73802,
  74088,
  74374,
  74516,
  74802,
  74945,
  75088,
  75159,
  75231,
  75302,
  75374,
  75445,
  75516,
  75802,
  75945,
  76088,
  76231,
  76659,
  76945,
  77231,
  77516,
  77588,
  77659,
  77731,
  77802,
  77874,
  77945,
  78016,
  78016,
  78088,
  79231,
  79516,
  79659,
  80088,
  80374,
  81231,
  81516,
  81802,
  81945,
  82159,
  82374,
  82659,
  83088,
  83516,
  83802,
  84231,
  84659,
  84945,
  85088,
  85231,
  85374,
  85516,
  85659,
  85802,
  85945,
  86088,
  86231,
  86374,
  86516,
  86659,
  86945,
  87231,
  88445,
  88874,
  89588,
  90016,
  90445,
  90659,
  90802,
  90945,
  91088,
  91874,
  92231,
  92945,
  93374,
  94088,
  94516,
  95016,
  95231,
  95374,
  95516,
  95659,
  95874,
  95945,
  95945,
  96016,
  96088,
  96159,
  96231,
  96302,
  96374,
  96445,
  96659,
  96945,
  97231,
  97516,
  97659,
  97802,
  98016,
  98088,
  98231,
  98374,
  98588,
  98731,
  98945,
  99231,
  99516,
  99874,
  100016,
  100159,
  100302,
  100445,
  100588,
  100731,
  100874,
  101016,
  101231,
  101516,
  101874,
  102088,
  102231,
  102374,
  102516,
  102659,
  102802,
  102945,
  103088,
  103231,
  103588,
  103802,
  104159,
  104231,
  104445,
  104516,
  104659,
  104802,
  104874,
  104945,
  105159,
  105159,
  105231,
  105302,
  105374,
  105445,
  105516,
  105802,
  106088,
  106374,
  106516,
  106659,
  106802,
  106945,
  107088,
  107159,
  107231,
  107374,
  107445,
  107516,
  107659,
  107802,
  108088,
  108374,
  108659,
  108802,
  108945,
  109088,
  109231,
  109374,
  109445,
  109516,
  109659,
  109731,
  109802,
  109945,
  110088,
  110374,
  110659,
  110945,
  111088,
  111231,
  111374,
  111516,
  111659,
  111731,
  111802,
  111945,
  112016,
  112088,
  112231,
  112374,
  112659,
  113016,
  113302,
  113445,
  113588,
  113659,
  113731,
  113731,
  113802,
  113874,
  113945,
  114016,
  114016,
  114231,
  114302,
  114374,
  114516,
  114659,
  117016,
  121588,
  121874,
  122159,
  122445,
  122659,
  122802,
  123016,
  123088,
  123302,
  123374,
  123445,
  123516,
  123588,
  123659,
  123731,
  123802,
  123874,
  124159,
  124374,
  124588,
  124874,
  125159,
  125302,
  125445,
  125731,
  126159,
  126445,
  126588,
  126874,
  127159,
  127445,
  127731,
  128016,
  128159,
  128302,
  128445,
  128731,
  129016,
  129302,
  129374,
  129659,
  129802,
  130088,
  130159,
  130231,
  130302,
  130374,
  130731,
  130874,
  131016,
  131159,
  131302,
  131445,
  131588,
  131731,
  131874,
  132016,
  132159,
  132302,
  132445,
  132516,
  132588,
  132659,
  132731,
  132802,
  132874,
  132945,
  133302,
  133445,
  133731,
  134016,
  134302,
  134588,
  134874,
  135302,
  135516,
  135659,
  135945,
  136302,
  136588,
  136802,
  137088,
  137231,
  137374,
  137588,
  137874,
  138159,
  138445,
  138588,
  138802,
  139016,
  139159,
  139231,
  139302,
  139374,
  139445,
  139516,
  139588,
  139874,
  140016,
  140159,
  140302,
  140731,
  141016,
  141802,
  142159,
  143302,
  143588,
  143659,
  144159,
  144374,
  145231,
  145516,
  145802,
  145945,
  146731,
  147159,
  147516,
  147874,
  148302,
  148659,
  148945,
  149159,
  149302,
  149445,
  149588,
  149731,
  149874,
  150016,
  150159,
  150302,
  150445,
  150588,
  150731,
  151016,
  151302,
  153516,
  153945,
  154374,
  154659,
  154802,
  154945,
  155088,
  155802,
  156231,
  156945,
  157302,
  158016,
  158445,
  158945,
  159231,
  159374,
  159516,
  159659,
  159802,
  159874,
  159945,
  160016,
  160088,
  160159,
  160159,
  160231,
  160302,
  160374,
  160945,
  161516,
  161802,
  162088,
  162659,
  163802,
  164088,
  164374,
  164659,
  164945,
  165516,
  166016,
  166302,
  166659,
  167231,
  167802,
  168302,
  168445,
  168445,
  168516,
  168588,
  168659,
  168731,
  168802,
  168874,
  168945,
  169016,
  169088,
  169159,
  169159,
  169231,
  169302,
  169374,
  169445,
  169516,
  169802,
  169945,
  170088,
  170231,
  170445,
  170516,
  170802,
  170945,
  171088,
  171231,
  171374,
  171516,
  171802,
  171945,
  172088,
  172231,
  172516,
  172802,
  173088,
  173231,
  173374,
  173516,
  173802,
  174088,
  174231,
  174374,
  174516,
  174659,
  174802,
  174945,
  175088,
  175231,
  175374,
  175516,
  175802,
  176088,
  176374,
  176516,
  176659,
  176802,
  177088,
  177374,
  177659,
  177945,
  178088,
  178374,
  178659,
  178731,
  178802,
  178874,
  178945,
  179016,
  179088,
  179159,
  179231,
  179302,
  179374,
  179445,
  179516,
  179588,
  179659,
  179731,
  179802,
  179874,
  179945,
  180016,
  180088,
  180159,
  180231,
  180302,
  180374,
  180445,
  180516,
  180588,
  180659,
  180731,
  180731,
  180802,
  180874,
  180945,
  181016,
  181088,
  181159,
  181231,
  181302,
  181374,
  181445,
  181516,
  181588,
  181659,
  181731,
  181802,
  181874,
  181945,
  182016,
  182088,
  182159,
  182231,
  182302,
  182374,
  182445,
  182516,
  182588,
  182659,
  182731,
  182802,
  182874,
  182945,
  183016,
  183088,
  183159,
  183302,
  183374,
  183516,
  183659,
  183802,
  183945,
  184088,
  184231,
  184374,
  184516,
  184659,
  184945,
  185231,
  185516,
  185659,
  185802,
  185945,
  186088,
  186231,
  186374,
  186516,
  186659,
  186945,
  187231,
  187516,
  187802,
  188088,
  188231,
  188374,
  188516,
  188659,
  188802,
  189088,
  189231,
  189374,
  189516,
  189802,
  190088,
  190231,
  190374,
  190516,
  190802,
  191088,
  191374,
  191659,
  191802,
  192088,
  192374,
  195802,
  195874,
  195945,
  196016,
  196088,
  196159,
  196231,
  196302,
  196374,
  196445,
  196516,
  196516,
  196659,
  196731,
  196731,
  196802,
  196874,
  196945,
  198088,
  198516,
  198945,
  199231,
  200374,
  200802,
  201231,
  201516,
  201659,
  201802,
  201945,
  202088,
  202231,
  202374,
  202516,
  202659,
  202802,
  202945,
  203088,
  203231,
  203374,
  203516,
  203802,
  203945,
  204088,
  204231,
  204374,
  204516,
  204659,
  204802,
  204945,
  205088,
  205231,
  205374,
  205588,
  205588,
  205659,
  205731,
  205802,
  205874,
  205945,
  206016,
  206088,
  206374,
  206516,
  206802,
  206945,
  207088,
  207374,
  207659,
  207945,
  208374,
  208659,
  208802,
  209088,
  209374,
  209659,
  209945,
  210231,
  210374,
  210516,
  210659,
  210945,
  211231,
  211516,
  211659,
  211945,
  212088,
  212231,
  212302,
  212374,
  212445,
  212516,
  212588,
  212659,
  212945,
  213088,
  213231,
  213445,
  213802,
  214088,
  214374,
  214516,
  214659,
  214731,
  214802,
  214874,
  214945,
  215016,
  215088,
  215159,
  215231,
  215516,
  215659,
  215945,
  216088,
  216231,
  216516,
  216802,
  217088,
  217516,
  217802,
  217945,
  218231,
  218516,
  218802,
  219088,
  219374,
  219516,
  219659,
  219802,
  220088,
  220374,
  220659,
  220802,
  221088,
  221231,
  221374,
  221445,
  221516,
  221588,
  221659,
  221731,
  221802,
  222088,
  222374,
  222659,
  222945,
  223231,
  223374,
  223516,
  223659,
  223802,
  223945,
  224088,
  224159,
  224231,
  224302,
  224374,
  224659,
  224945,
  225231,
  225516,
  225802,
  225945,
  226088,
  226374,
  226659,
  226945,
  227088,
  227231,
  227516,
  227802,
  228088,
  228374,
  228516,
  228659,
  228802,
  228945,
  229231,
  229516,
  229802,
  229945,
  230159,
  230374,
  230516,
  230588,
  230659,
  230731,
  230802,
  230874,
  230945,
  231231,
  231445,
  231588,
  231731,
  232088,
  232374,
  232659,
  232802,
  232874,
  232945,
  233016,
  233088,
  233159,
  233231,
  233516,
  234659,
  234945,
  235088,
  235445,
  235802,
  236588,
  236945,
  237231,
  237374,
  237516,
  237588,
  237659,
  237731,
  237731,
  237802,
  238088,
  238516,
  238874,
  239231,
  239659,
  240088,
  240374,
  240516,
  240588,
  240802,
  240945,
  241088,
  241231,
  241374,
  241516,
  241659,
  241802,
  241945,
  242088,
  242374,
  242659,
  243802,
  243945,
  244088,
  244231,
  244374,
  244445,
  244516,
  244588,
  244588,
  244802,
  244874,
  244945,
  245231,
  245374,
  245516,
  245802,
  246088,
  246231,
  246374,
  246516,
  246659,
  246731,
  246802,
  246874,
  246874,
  246945,
  247016,
  247088,
  247159,
  247231,
  247659,
  248374,
  248516,
  248659,
  248802,
  249516,
  249945,
  250374,
  250659,
  250802,
  250945,
  251088,
  251231,
  251302,
  251374,
  251445,
  251516,
  251588,
  251659,
  251731,
  251802,
  252088,
  252374,
  252659,
  252945,
  253231,
  253374,
  253516,
  253802,
  254088,
  254374,
  254516,
  254659,
  254945,
  255231,
  255516,
  255659,
  255802,
  255945,
  256088,
  256159,
  256231,
  256302,
  256374,
  256516,
  256659,
  256802,
  256945,
  257088,
  257231,
  257374,
  257516,
  257659,
  257802,
  257945,
  258088,
  258231,
  258374,
  258445,
  258516,
  258588,
  258659,
  258802,
  258945,
  259088,
  259231,
  259374,
  259516,
  259731,
  259802,
  259874,
  259945,
  260016,
  260088,
  260159,
  260231,
  260302,
  260374,
  260445,
  260445,
  260516,
  260588,
  260659,
  260731,
  260802,
  260874
]

const pop = document.querySelector('.audio-pop');
pop.volume = 0.5;

const music = document.querySelector('.music');
music.volume = 0.5;

//music controls
const progressBar = document.querySelector('.input-music');
const playBtn = document.querySelector('#playButton');
const pauseBtn = document.querySelector('#pauseButton');
const stopBtn = document.querySelector('#stopButton');
//кнопка для запуска теста сгенерированных нот
const playTestNotes = document.querySelector('.test-btn');

pauseBtn.addEventListener('click', () => {
  music.pause();
});

stopBtn.addEventListener('click', () => {
  music.pause();
  music.currentTime = 0;
});

music.addEventListener('timeupdate', () => {
  const progress = (music.currentTime / music.duration) * 1000;
  progressBar.value = progress;
});

progressBar.addEventListener('input', () => {
  let time = (progressBar.value / 1000) * music.duration;
  music.currentTime = time;
  //отчистили запланированные таймеры
  clearAllTimeouts();
  time = time.toFixed(3) * 1000;
  //изменили тайминги нот
  const newDelays = delays.map(delay => delay - time);
  newDelays.forEach(delay => {
    scheduleOfTimers(delay, popSound);
  });

});

//кнопки управляющие скоростью воспроизведения
const btnsSpeed = document.querySelectorAll('.btn-speed');

btnsSpeed.forEach(btn => {
  btn.onclick = (event) => {
    const speed = parseFloat(event.target.id);
    music.playbackRate = speed;
  }
});


let duration = 287138;    //в мс


//интервал минимальной доли при (bpm = 210)
const step = 71.4285715;
const timings = [];



const notes = [];
const startTiming = 374;

for (let i = startTiming; i < duration; i += step) {
  timings.push(parseInt(i));
}

const createTimingNote = (ms) => {
  for (let k = 0; k < timings.length; k++) {
    if (ms == timings[k] || ms == timings[k + 1]) {
      return ms;
    }

    if (ms > timings[k] && ms < timings[k + 1]) {
      const deltaLeft = ms - timings[k];
      const deltaRight = timings[k + 1] - ms;

      if (deltaLeft < deltaRight) {
        return timings[k]
      } else {
        return timings[k + 1]
      }
    }
  }
}

const popSound = () => {
  pop.currentTime = 0;
  pop.play();
}

//для хранения id запланированных таймеров
const timersIds = [];

//функция которая вызывает timeOut, сохраняет его id, и вызывает коллбэк
const scheduleOfTimers = (ms, callback) => {
  const timerId = setTimeout(() => {
    callback();
    timersIds.splice(timersIds.indexOf(timerId), 1);
  }, ms);
  timersIds.push(timerId);
}

//функция которая отменяет запланированные вызовы таймаутов
const clearAllTimeouts = () => {
  timersIds.forEach(id => {
    clearTimeout(id);
  });

  timersIds.length = 0;
}

//обработчик тестирования нот
playTestNotes.addEventListener('click', event => {
  music.currentTime = 0;
  music.play();
  console.log(notes);
  //цикл с генерацией нот
  delays.forEach(note => {
    scheduleOfTimers(note, popSound);
  });
});

stopBtn.addEventListener('click', () => {
  clearAllTimeouts();
});

const generetedNoteHtml = (obj) => {
  return `<div class="generated-notes__item">
              <div class="generated-notes__item-number">1.</div>
              <div class="generated-notes__item-content">
                <div class="generated-notes__item-top">
                  Тайминг: <span class="generated-notes__item-delay">${obj.delay}</span>
                </div>
                <div class="generated-notes__item-bot">
                  Колонка: <span class="generated-notes__item-column">${obj.column}</span>
                </div>
              </div>
              <div class="generated-notes__item-controls">
                <button class="generated-notes__item-btn-remove">Удалить</button>
                <button class="generated-notes__item-btn-edit">Редактировать</button>
              </div>
            </div>`;
}

//обработчик начала генерации нот
playBtn.addEventListener('click', event => {
  music.play();
  window.onkeydown = event => {
    if (event.code == 'KeyD' || event.code == 'KeyF') {
      const noteTiming = parseFloat(music.currentTime.toFixed(3)) * 1000;
      // console.log('noteTiming- ' + noteTiming);
      // console.log(createTimingNote(noteTiming));
      notes.push(createTimingNote(noteTiming));
    }
  };
});
